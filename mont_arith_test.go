package mont_arith

import (
    "fmt"
	"math/big"
    "math/rand"
	"testing"
    "strconv"
)

func randBigInt(r *rand.Rand, modulus *big.Int, limbCount uint) *big.Int {
    resBytes := make([]byte, limbCount * 8)
    for i := 0; i < int(limbCount) * 8; i++ {
        resBytes[i] = byte(r.Int())
    }

    res := new(big.Int).SetBytes(resBytes)
    return res.Mod(res, modulus)
}

func TestMulMontBLS12831(t *testing.T) {
	montCtx := NewField(MaxLimbs, DefaultPreset())
    modInt, _ := new(big.Int).SetString("1a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaab", 16)

    var limbCount uint = 6
    mod := IntToLimbs(modInt, limbCount)
    montCtx.SetMod(mod)

    s := rand.NewSource(42)
    r := rand.New(s)

    x := IntToLimbs(randBigInt(r, LimbsToInt(montCtx.Modulus), limbCount), limbCount)
    montX := montCtx.ToMont(x)
    if !Eq(montCtx.ToNorm(montX), x) {
        panic("mont form should have correct normal form")
    }

    y := IntToLimbs(randBigInt(r, LimbsToInt(montCtx.Modulus), limbCount), limbCount)
    montY := montCtx.ToMont(y)
    if !Eq(montCtx.ToNorm(montY), y) {
        panic("mont form should have correct normal form")
    }

    out := make([]uint64, limbCount)
    montCtx.MulMont(montCtx, LimbsToLEBytes(out), LimbsToLEBytes(x), LimbsToLEBytes(y))
    // TODO assert that the result is correct
}

func testInputs() []string {
    return []string{"18446744073709551614","18446744073709551614","18446744073709551615","1", "2","18446744073709551614","18446744073709551615","1", "0","0","18446744073709551615","1", "1","1","18446744073709551615","1", "9223372036854775808","9223372036854775808","18446744073709551615","1", "4294967294","4294967294","4294967295","1", "2","4294967294","4294967295","1", "0","0","4294967295","1", "1","1","4294967295","1", "2147483647","2147483647","4294967295","1", "340282366920938463463374607431768211454","340282366920938463463374607431768211454","340282366920938463463374607431768211455","2", "2","340282366920938463463374607431768211454","340282366920938463463374607431768211455","2", "0","0","340282366920938463463374607431768211455","2", "1","1","340282366920938463463374607431768211455","2", "170141183460469231731687303715884105728","170141183460469231731687303715884105728","340282366920938463463374607431768211455","2", "18446744073709551616","18446744073709551616","18446744073709551617","2", "2","18446744073709551616","18446744073709551617","2", "0","0","18446744073709551617","2", "1","1","18446744073709551617","2", "9223372036854775808","9223372036854775808","18446744073709551617","2", "79228162514264337593543950334","79228162514264337593543950334","79228162514264337593543950335","2", "2","79228162514264337593543950334","79228162514264337593543950335","2", "0","0","79228162514264337593543950335","2", "1","1","79228162514264337593543950335","2", "39614081257132168796771975168","39614081257132168796771975168","79228162514264337593543950335","2", "6277101735386680763835789423207666416102355444464034512894","6277101735386680763835789423207666416102355444464034512894","6277101735386680763835789423207666416102355444464034512895","3", "2","6277101735386680763835789423207666416102355444464034512894","6277101735386680763835789423207666416102355444464034512895","3", "0","0","6277101735386680763835789423207666416102355444464034512895","3", "1","1","6277101735386680763835789423207666416102355444464034512895","3", "3138550867693340381917894711603833208051177722232017256448","3138550867693340381917894711603833208051177722232017256448","6277101735386680763835789423207666416102355444464034512895","3", "340282366920938463463374607431768211456","340282366920938463463374607431768211456","340282366920938463463374607431768211457","3", "2","340282366920938463463374607431768211456","340282366920938463463374607431768211457","3", "0","0","340282366920938463463374607431768211457","3", "1","1","340282366920938463463374607431768211457","3", "170141183460469231731687303715884105728","170141183460469231731687303715884105728","340282366920938463463374607431768211457","3", "1461501637330902918203684832716283019655932542974","1461501637330902918203684832716283019655932542974","1461501637330902918203684832716283019655932542975","3", "2","1461501637330902918203684832716283019655932542974","1461501637330902918203684832716283019655932542975","3", "0","0","1461501637330902918203684832716283019655932542975","3", "1","1","1461501637330902918203684832716283019655932542975","3", "730750818665451459101842416358141509827966271488","730750818665451459101842416358141509827966271488","1461501637330902918203684832716283019655932542975","3", "115792089237316195423570985008687907853269984665640564039457584007913129639934","115792089237316195423570985008687907853269984665640564039457584007913129639934","115792089237316195423570985008687907853269984665640564039457584007913129639935","4", "2","115792089237316195423570985008687907853269984665640564039457584007913129639934","115792089237316195423570985008687907853269984665640564039457584007913129639935","4", "0","0","115792089237316195423570985008687907853269984665640564039457584007913129639935","4", "1","1","115792089237316195423570985008687907853269984665640564039457584007913129639935","4", "57896044618658097711785492504343953926634992332820282019728792003956564819968","57896044618658097711785492504343953926634992332820282019728792003956564819968","115792089237316195423570985008687907853269984665640564039457584007913129639935","4", "6277101735386680763835789423207666416102355444464034512896","6277101735386680763835789423207666416102355444464034512896","6277101735386680763835789423207666416102355444464034512897","4", "2","6277101735386680763835789423207666416102355444464034512896","6277101735386680763835789423207666416102355444464034512897","4", "0","0","6277101735386680763835789423207666416102355444464034512897","4", "1","1","6277101735386680763835789423207666416102355444464034512897","4", "3138550867693340381917894711603833208051177722232017256448","3138550867693340381917894711603833208051177722232017256448","6277101735386680763835789423207666416102355444464034512897","4", "26959946667150639794667015087019630673637144422540572481103610249214","26959946667150639794667015087019630673637144422540572481103610249214","26959946667150639794667015087019630673637144422540572481103610249215","4", "2","26959946667150639794667015087019630673637144422540572481103610249214","26959946667150639794667015087019630673637144422540572481103610249215","4", "0","0","26959946667150639794667015087019630673637144422540572481103610249215","4", "1","1","26959946667150639794667015087019630673637144422540572481103610249215","4", "13479973333575319897333507543509815336818572211270286240551805124608","13479973333575319897333507543509815336818572211270286240551805124608","26959946667150639794667015087019630673637144422540572481103610249215","4", "2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936574","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936574","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575","5", "2","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936574","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575","5", "0","0","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575","5", "1","1","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575","5", "1067993517960455041197510853084776057301352261178326384973520803911109862890320275011481043468288","1067993517960455041197510853084776057301352261178326384973520803911109862890320275011481043468288","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575","5", "115792089237316195423570985008687907853269984665640564039457584007913129639936","115792089237316195423570985008687907853269984665640564039457584007913129639936","115792089237316195423570985008687907853269984665640564039457584007913129639937","5", "2","115792089237316195423570985008687907853269984665640564039457584007913129639936","115792089237316195423570985008687907853269984665640564039457584007913129639937","5", "0","0","115792089237316195423570985008687907853269984665640564039457584007913129639937","5", "1","1","115792089237316195423570985008687907853269984665640564039457584007913129639937","5", "57896044618658097711785492504343953926634992332820282019728792003956564819968","57896044618658097711785492504343953926634992332820282019728792003956564819968","115792089237316195423570985008687907853269984665640564039457584007913129639937","5", "497323236409786642155382248146820840100456150797347717440463976893159497012533375533054","497323236409786642155382248146820840100456150797347717440463976893159497012533375533054","497323236409786642155382248146820840100456150797347717440463976893159497012533375533055","5", "2","497323236409786642155382248146820840100456150797347717440463976893159497012533375533054","497323236409786642155382248146820840100456150797347717440463976893159497012533375533055","5", "0","0","497323236409786642155382248146820840100456150797347717440463976893159497012533375533055","5", "1","1","497323236409786642155382248146820840100456150797347717440463976893159497012533375533055","5", "248661618204893321077691124073410420050228075398673858720231988446579748506266687766528","248661618204893321077691124073410420050228075398673858720231988446579748506266687766528","497323236409786642155382248146820840100456150797347717440463976893159497012533375533055","5", "39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306814","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306814","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306815","6", "2","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306814","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306815","6", "0","0","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306815","6", "1","1","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306815","6", "19701003098197239606139520050071806902539869635232723333974146702122860885748605305707133127442457820403313995153408","19701003098197239606139520050071806902539869635232723333974146702122860885748605305707133127442457820403313995153408","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306815","6", "2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936576","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936576","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936577","6", "2","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936576","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936577","6", "0","0","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936577","6", "1","1","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936577","6", "1067993517960455041197510853084776057301352261178326384973520803911109862890320275011481043468288","1067993517960455041197510853084776057301352261178326384973520803911109862890320275011481043468288","2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936577","6", "9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218494","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218494","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218495","6", "2","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218494","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218495","6", "0","0","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218495","6", "1","1","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218495","6", "4586997231980143023221641790604173881593129978336562247475177678773845752176969616140037106220251373109248","4586997231980143023221641790604173881593129978336562247475177678773845752176969616140037106220251373109248","9173994463960286046443283581208347763186259956673124494950355357547691504353939232280074212440502746218495","6", "726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614654","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614654","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614655","7", "2","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614654","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614655","7", "0","0","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614655","7", "1","1","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614655","7", "363419362147803445274661903944002267176820680343659030140745099590319644056698961663095525356881782780381260803133088966767300814307328","363419362147803445274661903944002267176820680343659030140745099590319644056698961663095525356881782780381260803133088966767300814307328","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614655","7", "39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306816","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306816","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306817","7", "2","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306816","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306817","7", "0","0","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306817","7", "1","1","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306817","7", "19701003098197239606139520050071806902539869635232723333974146702122860885748605305707133127442457820403313995153408","19701003098197239606139520050071806902539869635232723333974146702122860885748605305707133127442457820403313995153408","39402006196394479212279040100143613805079739270465446667948293404245721771497210611414266254884915640806627990306817","7", "169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889534","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889534","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889535","7", "2","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889534","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889535","7", "0","0","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889535","7", "1","1","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889535","7", "84615164005151820665845159428194693098035799419427996068435045795123941278247852265624218936283556460491675139202989862944768","84615164005151820665845159428194693098035799419427996068435045795123941278247852265624218936283556460491675139202989862944768","169230328010303641331690318856389386196071598838855992136870091590247882556495704531248437872567112920983350278405979725889535","7", "13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084094","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084094","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095","8", "2","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084094","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095","8", "0","0","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095","8", "1","1","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095","8", "6703903964971298549787012499102923063739682910296196688861780721860882015036773488400937149083451713845015929093243025426876941405973284973216824503042048","6703903964971298549787012499102923063739682910296196688861780721860882015036773488400937149083451713845015929093243025426876941405973284973216824503042048","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084095","8", "726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614656","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614656","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614657","8", "2","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614656","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614657","8", "0","0","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614657","8", "1","1","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614657","8", "363419362147803445274661903944002267176820680343659030140745099590319644056698961663095525356881782780381260803133088966767300814307328","363419362147803445274661903944002267176820680343659030140745099590319644056698961663095525356881782780381260803133088966767300814307328","726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606266177933534601628614657","8", "3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290174","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290174","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290175","8", "2","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290174","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290175","8", "0","0","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290175","8", "1","1","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290175","8", "1560874275157996115690798614896583152874299071332485575429578479812685869409882810060153051531745985579913465560703311447723987839644142653145088","1560874275157996115690798614896583152874299071332485575429578479812685869409882810060153051531745985579913465560703311447723987839644142653145088","3121748550315992231381597229793166305748598142664971150859156959625371738819765620120306103063491971159826931121406622895447975679288285306290175","8", "247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699134","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699134","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699135","9", "2","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699134","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699135","9", "0","0","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699135","9", "1","1","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699135","9", "123665200736552267030251260509823595017565674550605919957031528046448612553265933585158200530621522494798835713008069669675682517153375604983773077550946583958303386074349568","123665200736552267030251260509823595017565674550605919957031528046448612553265933585158200530621522494798835713008069669675682517153375604983773077550946583958303386074349568","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699135","9", "13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084096","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084096","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084097","9", "2","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084096","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084097","9", "0","0","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084097","9", "1","1","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084097","9", "6703903964971298549787012499102923063739682910296196688861780721860882015036773488400937149083451713845015929093243025426876941405973284973216824503042048","6703903964971298549787012499102923063739682910296196688861780721860882015036773488400937149083451713845015929093243025426876941405973284973216824503042048","13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946569946433649006084097","9", "57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724414","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724414","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724415","9", "2","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724414","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724415","9", "0","0","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724415","9", "1","1","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724415","9", "28793048285076456849987446449190283896766061557132266451844835664715760516297522370041860391064901485759493828054533728788532902755163518009654497157537048672862208","28793048285076456849987446449190283896766061557132266451844835664715760516297522370041860391064901485759493828054533728788532902755163518009654497157537048672862208","57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036019308994315074097345724415","9", "4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603774","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603774","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603775","10", "2","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603774","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603775","10", "0","0","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603775","10", "1","1","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603775","10", "2281220308811097609320585802850145662446614253624279965289596258949637583604338693252956405658685699889321154786797203655344352360687718999126330659861107094125997337180132475041437096123301888","2281220308811097609320585802850145662446614253624279965289596258949637583604338693252956405658685699889321154786797203655344352360687718999126330659861107094125997337180132475041437096123301888","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603775","10", "247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699136","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699136","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699137","10", "2","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699136","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699137","10", "0","0","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699137","10", "1","1","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699137","10", "123665200736552267030251260509823595017565674550605919957031528046448612553265933585158200530621522494798835713008069669675682517153375604983773077550946583958303386074349568","123665200736552267030251260509823595017565674550605919957031528046448612553265933585158200530621522494798835713008069669675682517153375604983773077550946583958303386074349568","247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772148699137","10", "1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456254","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456254","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456255","10", "2","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456254","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456255","10", "0","0","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456255","10", "1","1","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456255","10", "531137992816767098689588206552468627329593117727031923199444138200403559860852242739162502265229285668889329486246501015346579337652707239409519978766587351943831270835393219031728128","531137992816767098689588206552468627329593117727031923199444138200403559860852242739162502265229285668889329486246501015346579337652707239409519978766587351943831270835393219031728128","1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670786438063456255","10", "84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502014","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502014","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502015","11", "2","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502014","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502015","11", "0","0","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502015","11", "1","1","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502015","11", "42081087212386988057927919063041029324402718422585390875986247224549857234376646576909332290220707609815863750849425741704155458001470430905022518165215046799641789369027556785533310063074581738170346013886251008","42081087212386988057927919063041029324402718422585390875986247224549857234376646576909332290220707609815863750849425741704155458001470430905022518165215046799641789369027556785533310063074581738170346013886251008","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502015","11", "4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603776","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603776","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603777","11", "2","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603776","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603777","11", "0","0","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603777","11", "1","1","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603777","11", "2281220308811097609320585802850145662446614253624279965289596258949637583604338693252956405658685699889321154786797203655344352360687718999126330659861107094125997337180132475041437096123301888","2281220308811097609320585802850145662446614253624279965289596258949637583604338693252956405658685699889321154786797203655344352360687718999126330659861107094125997337180132475041437096123301888","4562440617622195218641171605700291324893228507248559930579192517899275167208677386505912811317371399778642309573594407310688704721375437998252661319722214188251994674360264950082874192246603777","11", "19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109694","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109694","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109695","11", "2","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109694","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109695","11", "0","0","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109695","11", "1","1","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109695","11", "9797766621314684873895700802803279209044463565243731922466831101232640732633100491228823617617764419367505179450247842283955649007454149170085442756585554871624752266571753841250508572690789992495054848","9797766621314684873895700802803279209044463565243731922466831101232640732633100491228823617617764419367505179450247842283955649007454149170085442756585554871624752266571753841250508572690789992495054848","19595533242629369747791401605606558418088927130487463844933662202465281465266200982457647235235528838735010358900495684567911298014908298340170885513171109743249504533143507682501017145381579984990109695","11", "1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057854","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057854","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057855","12", "2","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057854","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057855","12", "0","0","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057855","12", "1","1","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057855","12", "776259046150354467574489744231251277628443008558348305569526019013025476343188443165439204414323238975243865348565536603085790022057407195722143637520590569602227488010424952775132642815799222412631499596858234375446423426908028928","776259046150354467574489744231251277628443008558348305569526019013025476343188443165439204414323238975243865348565536603085790022057407195722143637520590569602227488010424952775132642815799222412631499596858234375446423426908028928","1552518092300708935148979488462502555256886017116696611139052038026050952686376886330878408828646477950487730697131073206171580044114814391444287275041181139204454976020849905550265285631598444825262999193716468750892846853816057855","12", "84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502016","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502016","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502017","12", "2","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502016","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502017","12", "0","0","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502017","12", "1","1","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502017","12", "42081087212386988057927919063041029324402718422585390875986247224549857234376646576909332290220707609815863750849425741704155458001470430905022518165215046799641789369027556785533310063074581738170346013886251008","42081087212386988057927919063041029324402718422585390875986247224549857234376646576909332290220707609815863750849425741704155458001470430905022518165215046799641789369027556785533310063074581738170346013886251008","84162174424773976115855838126082058648805436845170781751972494449099714468753293153818664580441415219631727501698851483408310916002940861810045036330430093599283578738055113571066620126149163476340692027772502017","12", "361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068734","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068734","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068735","12", "2","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068734","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068735","12", "0","0","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068735","12", "1","1","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068735","12", "180736893357325919804742965901096183254486650358500961579737723575212405143116703993975930943694719806137463391890175780999890999416217020648099397663164550811570949854893831716648452639533025774320471006645409943407034368","180736893357325919804742965901096183254486650358500961579737723575212405143116703993975930943694719806137463391890175780999890999416217020648099397663164550811570949854893831716648452639533025774320471006645409943407034368","361473786714651839609485931802192366508973300717001923159475447150424810286233407987951861887389439612274926783780351561999781998832434041296198795326329101623141899709787663433296905279066051548640942013290819886814068735","12"}
}

func TestAddModInputs(t *testing.T) {
    inputs := testInputs()

    for i := 0; i < len(inputs); i += 4 {
        testAddMod(t, inputs[i], inputs[i + 1], inputs[i + 2], inputs[i + 3])
    }
}

func testAddMod(t *testing.T, xStr, yStr, modStr, limbCountStr string) {
    xInt, ok := new(big.Int).SetString(xStr, 10)
    if !ok {
        t.Fatalf("could not parse x")
    }

    yInt, ok := new(big.Int).SetString(yStr, 10)
    if !ok {
        t.Fatalf("could not parse y")
    }

    modInt, ok := new(big.Int).SetString(modStr, 10)
    if !ok {
        t.Fatalf("could not parse mod")
    }

    limbCount, err := strconv.Atoi(limbCountStr)

    mod := IntToLimbs(modInt, uint(limbCount))
    xLimbs := IntToLimbs(xInt, uint(limbCount))
    yLimbs := IntToLimbs(yInt, uint(limbCount))
    resultBytes := make([]byte, limbCount * 8)

	montCtx := NewField(MaxLimbs, DefaultPreset())
	err = montCtx.SetMod(mod)
	if err != nil {
		panic("error")
	}

    expected := new(big.Int)
    expected.Add(xInt,yInt).Mod(expected, modInt)

    if err = montCtx.AddMod(montCtx, resultBytes, LimbsToLEBytes(xLimbs), LimbsToLEBytes(yLimbs)); err != nil {
        t.Fatal(err)
    }

    result := LEBytesToInt(resultBytes)
    if result.Cmp(expected) != 0 {
		t.Fatalf("result (%x) != expected (%x)\n", result, expected)
    }
}

func TestSubModInputs(t *testing.T) {
    inputs := testInputs()

    for i := 0; i < len(inputs); i += 4 {
        testAddMod(t, inputs[i], inputs[i + 1], inputs[i + 2], inputs[i + 3])
    }
}

func testSubMod(t *testing.T, xStr, yStr, modStr, limbCountStr string) {
    xInt, ok := new(big.Int).SetString(xStr, 10)
    if !ok {
        t.Fatalf("could not parse x")
    }

    yInt, ok := new(big.Int).SetString(yStr, 10)
    if !ok {
        t.Fatalf("could not parse y")
    }

    modInt, ok := new(big.Int).SetString(modStr, 10)
    if !ok {
        t.Fatalf("could not parse mod")
    }

    limbCount, err := strconv.Atoi(limbCountStr)

    mod := IntToLimbs(modInt, uint(limbCount))
    xLimbs := IntToLimbs(xInt, uint(limbCount))
    yLimbs := IntToLimbs(yInt, uint(limbCount))
    resultBytes := make([]byte, limbCount * 8)

	montCtx := NewField(MaxLimbs, DefaultPreset())
	err = montCtx.SetMod(mod)
	if err != nil {
		panic("error")
	}

    expected := new(big.Int)
    expected.Sub(xInt,yInt).Mod(expected, modInt)

    if err = montCtx.SubMod(montCtx, resultBytes, LimbsToLEBytes(xLimbs), LimbsToLEBytes(yLimbs)); err != nil {
        t.Fatal(err)
    }

    result := LEBytesToInt(resultBytes)
    if result.Cmp(expected) != 0 {
		t.Fatalf("result (%x) != expected (%x)\n", result, expected)
    }
}

func TestMulMontInputs(t *testing.T) {
    inputs := testInputs()

    for i := 0; i < len(inputs); i += 4 {
        testMulMont(t, inputs[i], inputs[i + 1], inputs[i + 2], inputs[i + 3])
    }
}

func testMulMont(t *testing.T, xStr, yStr, modStr, limbCountStr string) {
    xInt, ok := new(big.Int).SetString(xStr, 10)
    if !ok {
        t.Fatalf("could not parse x")
    }

    yInt, ok := new(big.Int).SetString(yStr, 10)
    if !ok {
        t.Fatalf("could not parse y")
    }

    modInt, ok := new(big.Int).SetString(modStr, 10)
    if !ok {
        t.Fatalf("could not parse mod")
    }

    limbCount, err := strconv.Atoi(limbCountStr)

    mod := IntToLimbs(modInt, uint(limbCount))
    xLimbs := IntToLimbs(xInt, uint(limbCount))
    yLimbs := IntToLimbs(yInt, uint(limbCount))
    resultBytes := make([]byte, limbCount * 8)
    // rInv := pow(-r, -1, mod)
    rInv := big.NewInt(1)
    rInv.Lsh(rInv, uint(limbCount) * 8)
    rInv.Neg(rInv)
    rInv.ModInverse(rInv, modInt)

    expected := new(big.Int)
    expected.Mul(xInt, yInt)
    expected.Mul(expected, rInv)
    expected.Mod(expected, modInt)

	montCtx := NewField(MaxLimbs, DefaultPreset())
	err = montCtx.SetMod(mod)
	if err != nil {
		panic("error")
	}

    if err = montCtx.MulMont(montCtx, resultBytes, LimbsToLEBytes(xLimbs), LimbsToLEBytes(yLimbs)); err != nil {
        t.Fatal(err)
    }

    result := LEBytesToInt(resultBytes)
    if result.Cmp(expected) != 0 {
        fmt.Println(xLimbs)
        fmt.Println(yLimbs)
        fmt.Println(mod)
        fmt.Println(montCtx.MontParamInterleaved)
		t.Fatalf("result (%x) != expected (%x)\n", result, expected)
    }
}

func TestMontgomeryConversion(t *testing.T) {
    for i := 0; i < MAX_LIMBS; i++ {
        // convert 1 to montgomery and then back using RSquared and mulmont instead of ToMont ToNorm helpers
    }
}
